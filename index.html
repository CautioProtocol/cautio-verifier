<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cautio Verifier</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Roboto+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.4/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
  <style>
    :root {
      --bg0: #0a0e17;
      --bg1: #11151f;
      --card: #161b22;
      --border: #30363d;
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.62);
      --muted2: rgba(255,255,255,0.48);
      --cyan: #00d4ff;
      --green: #00ff9d;
      --red: #ff4d4f;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      font-size: 14px;
      line-height: 1.55;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px 16px;
      background: linear-gradient(135deg, var(--bg0) 0%, var(--bg1) 100%);
    }
    .page { width: 100%; max-width: 560px; display: flex; flex-direction: column; align-items: center; gap: 16px; }
    .card {
      width: 100%;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6), 0 10px 30px -5px rgba(0,0,0,0.4);
      padding: 24px;
      transition: border-color 200ms ease, box-shadow 200ms ease;
    }
    .card.state-invalid {
      border-color: rgba(255, 77, 79, 0.6);
      box-shadow: 0 20px 40px -10px rgba(0,0,0,0.6), 0 0 0 1px rgba(255, 77, 79, 0.25);
    }
    .header { margin-bottom: 20px; }
    .brand { display: flex; align-items: center; gap: 12px; }
    .lock { width: 24px; height: 24px; flex-shrink: 0; opacity: 0.9; }
    .title { font-size: 20px; font-weight: 700; letter-spacing: -0.02em; }
    .subtitle { font-size: 14px; color: var(--muted); margin-top: 4px; }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 28px 20px;
      text-align: center;
      cursor: pointer;
      user-select: none;
      background: rgba(255,255,255,0.02);
      transition: border-color 180ms ease, background 180ms ease;
    }
    .drop-zone { transition: opacity 300ms ease; }
    .drop-zone:hover { border-color: var(--cyan); background: rgba(0, 212, 255, 0.05); }
    .drop-zone.dragover { border-color: var(--cyan); background: rgba(0, 212, 255, 0.08); }
    .card:has(.result.show) .drop-zone { opacity: 0; pointer-events: none; }
    .drop-title { font-weight: 600; font-size: 14px; }
    .drop-sub { margin-top: 8px; font-size: 12px; color: var(--muted2); }
    .file-pill {
      margin-top: 12px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(255,255,255,0.04);
      font-size: 12px;
      color: var(--muted);
      max-width: 100%;
    }
    .file-pill code { font-family: var(--mono); font-size: 12px; color: rgba(255,255,255,0.85); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 360px; }
    .hidden { display: none !important; }
    .result { margin-top: 20px; opacity: 0; transform: translateY(8px); transition: opacity 300ms ease, transform 400ms ease; display: none; }
    .result.show { display: block; opacity: 1; transform: translateY(0); }
    .result.fade-out { opacity: 0; }
    .status-row { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: center; margin-bottom: 4px; }
    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 700;
      letter-spacing: 0.03em;
      font-size: 12px;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
    }
    .pill.verified { border-color: rgba(0, 255, 157, 0.35); color: #fff; background: var(--green); animation: pulse-verified 1.5s ease-in-out infinite; }
    .pill.tamper { border-color: rgba(255, 77, 79, 0.5); color: var(--red); background: rgba(255, 77, 79, 0.1); }
    @keyframes pulse-verified { 0%, 100% { transform: scale(1.02); } 50% { transform: scale(1); } }
    .status-msg { color: var(--muted); font-size: 14px; }
    .error-banner {
      margin-top: 14px;
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(255, 77, 79, 0.35);
      background: rgba(255, 77, 79, 0.08);
      color: rgba(255,255,255,0.9);
      font-size: 12px;
      display: none;
    }
    .error-banner.show { display: block; }
    .kv { margin-top: 18px; display: grid; gap: 10px; }
    .kv-row { display: grid; grid-template-columns: 140px 1fr; gap: 12px; align-items: start; }
    .kv-key { color: var(--muted2); font-size: 12px; }
    .kv-val { color: rgba(255,255,255,0.88); font-size: 12px; min-width: 0; }
    .kv-val-mono { font-family: 'Roboto Mono', monospace; font-size: 14px; }
    .kv-row-tsa .kv-key { font-size: 14px; }
    .footer-tsa { font-size: 12px; color: rgba(255,255,255,0.4); text-align: center; padding: 4px 8px; }
    .code { font-size: 11px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); border-radius: 8px; padding: 8px 10px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: rgba(255,255,255,0.9); }
    .code .hash { font-family: 'Roboto Mono', monospace; }
    .code.mismatch { border-color: rgba(255, 77, 79, 0.4); background: rgba(255, 77, 79, 0.08); }
    .section { margin-top: 20px; padding-top: 18px; border-top: 1px solid rgba(255,255,255,0.08); }
    .section-title { font-size: 12px; color: var(--muted2); letter-spacing: 0.06em; text-transform: uppercase; margin-bottom: 10px; }
    .warn { border-radius: 8px; padding: 8px 12px; border: 1px solid rgba(0, 212, 255, 0.25); background: rgba(0, 212, 255, 0.05); color: rgba(255,255,255,0.85); font-size: 12px; display: none; margin-bottom: 10px; }
    .warn.show { display: block; }
    .preview { border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2); padding: 12px; max-height: 220px; overflow: auto; font-family: var(--mono); font-size: 12px; white-space: pre-wrap; word-break: break-word; color: rgba(255,255,255,0.86); }
    .preview img { max-width: 100%; max-height: 200px; display: block; border-radius: 8px; }
    .compare { margin-top: 18px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); padding: 14px; display: none; }
    .compare.show { display: block; }
    .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 12px; }
    .panel { border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); overflow: hidden; }
    .panel-title { font-size: 11px; color: rgba(255,255,255,0.7); padding: 8px 10px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .panel.computed .panel-title { background: rgba(255, 77, 79, 0.08); }
    .panel.expected .hash-block { background: #2d2d2d; }
    .panel.computed .hash-block { background: #442a2a; }
    .hash-block { font-family: 'Roboto Mono', monospace; font-size: 11px; padding: 10px; line-height: 1.5; word-break: break-all; color: rgba(255,255,255,0.88); background: rgba(0,0,0,0.2); min-height: 60px; }
    .diff { color: rgba(255,255,255,0.9); }
    .diff-mismatch { color: #ff8080; background: #661a1a; border-radius: 2px; padding: 0 1px; }
    .conclusion { margin-top: 12px; color: rgba(255,255,255,0.85); font-size: 12px; }
    .conclusion strong { color: rgba(255,255,255,0.95); }
    .merkle-viz { margin-top: 10px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.15); padding: 12px; }
    .merkle-viz.invalid { border-color: rgba(255, 77, 79, 0.35); background: rgba(255, 77, 79, 0.05); }
    .merkle-viz.valid { border-color: rgba(0, 255, 157, 0.25); }
    .merkle-row { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 8px; flex-wrap: wrap; }
    .merkle-node { font-family: var(--mono); font-size: 11px; padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.12); background: rgba(255,255,255,0.03); color: rgba(255,255,255,0.75); max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .merkle-node.valid { border-color: rgba(0, 255, 157, 0.35); color: var(--green); background: rgba(0, 255, 157, 0.06); }
    .merkle-node.invalid { border-color: rgba(255, 77, 79, 0.45); color: var(--red); background: rgba(255, 77, 79, 0.08); }
    .merkle-connector { font-size: 12px; color: var(--muted2); }
    .actions { margin-top: 20px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .btn {
      border-radius: 8px;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 13px;
      border: 1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.04);
      color: rgba(255,255,255,0.92);
      cursor: pointer;
      font-family: inherit;
      transition: border-color 160ms ease, background 160ms ease;
    }
    .btn:hover { border-color: var(--cyan); background: rgba(0, 212, 255, 0.06); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-secondary { border-color: rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); color: rgba(255,255,255,0.7); }
    .btn-secondary:hover { border-color: rgba(255,255,255,0.18); background: rgba(255,255,255,0.04); }
    .footer { font-size: 12px; color: rgba(255,255,255,0.4); text-align: center; padding: 8px; }
    @media (max-width: 520px) {
      .compare-grid { grid-template-columns: 1fr; }
      .kv-row { grid-template-columns: 1fr; }
      .file-pill code { max-width: 240px; }
    }
  </style>
</head>
<body>
  <div class="page">
    <div id="appCard" class="card">
      <div class="header">
        <div class="brand">
          <svg class="lock" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M7.5 10V7.75C7.5 5.12665 9.62665 3 12.25 3C14.8734 3 17 5.12665 17 7.75V10" stroke="rgba(255,255,255,0.75)" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M6.5 10H17.5C18.6046 10 19.5 10.8954 19.5 12V19C19.5 20.1046 18.6046 21 17.5 21H6.5C5.39543 21 4.5 20.1046 4.5 19V12C4.5 10.8954 5.39543 10 6.5 10Z" stroke="rgba(255,255,255,0.75)" stroke-width="1.6" />
            <path d="M12 14.25V16.75" stroke="rgba(255,255,255,0.75)" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <div>
            <div class="title">Cautio Verifier</div>
            <div class="subtitle">Offline cryptographic integrity check • Client-side execution</div>
          </div>
        </div>
      </div>

      <div id="dropZone" class="drop-zone" role="button" tabindex="0" aria-label="Drop zone for proof.json">
        <div id="dropZoneText" class="drop-title">Drop proof.json here or click to browse</div>
        <div class="drop-sub">Fully offline — no data upload</div>
        <div id="loadedFileName" class="file-pill hidden"><span>Loaded</span><code id="loadedFileCode"></code></div>
      </div>

      <div id="resultsCard" class="result" aria-live="polite" role="status">
        <div class="status-row">
          <div id="statusPill" class="pill">VERIFYING</div>
          <div id="statusText" class="status-msg"></div>
        </div>
        <div id="errorBanner" class="error-banner"><div id="errorMsg"></div></div>
        <div class="kv">
          <div class="kv-row">
            <div class="kv-key">Hash Algorithm</div>
            <div id="algorithmLabel" class="kv-val">Keccak-256</div>
          </div>
          <div class="kv-row kv-row-tsa">
            <div class="kv-key">Timestamp Authority</div>
            <div class="kv-val kv-val-mono">DigiCert SHA256 RFC3161 TSA</div>
          </div>
          <div class="kv-row kv-row-tsa">
            <div class="kv-key">Verification Date</div>
            <div id="verificationDateVal" class="kv-val kv-val-mono">—</div>
          </div>
          <div class="kv-row">
            <div class="kv-key">Provided Root</div>
            <div class="kv-val"><div id="expectedRootCode" class="code" title=""></div></div>
          </div>
          <div class="kv-row">
            <div class="kv-key">Computed Root</div>
            <div class="kv-val"><div id="computedRootCode" class="code" title=""></div></div>
          </div>
        </div>
        <div id="compareSection" class="compare">
          <div class="section-title">Forensic Comparison</div>
          <div class="compare-grid">
            <div class="panel expected">
              <div class="panel-title">Expected Hash (from Timestamp)</div>
              <div id="expectedHashBlock" class="hash-block"></div>
            </div>
            <div class="panel computed">
              <div class="panel-title">Calculated Hash (from Content)</div>
              <div id="computedHashBlock" class="hash-block computed"></div>
            </div>
          </div>
          <div id="conclusionText" class="conclusion"></div>
        </div>
        <div class="section">
          <div class="section-title">Decoded Content Preview</div>
          <div id="largeFileWarning" class="warn">Large proof file — performance may vary.</div>
          <div id="previewTruncatedBanner" class="warn">Large file — full content truncated for performance.</div>
          <div id="preview" class="preview"></div>
        </div>
        <div class="section">
          <div class="section-title">Merkle Path</div>
          <div id="merkleViz" class="merkle-viz"></div>
        </div>
        <div class="actions">
          <button id="downloadReport" class="btn">Export Report (PDF)</button>
          <button id="resetBtn" class="btn btn-secondary" type="button">Verify Another Proof</button>
        </div>
      </div>
    </div>
    <div class="footer">© 2026 Cautio • Client-side • MIT licensed verifier • No data transmitted</div>
    <div id="tsaFooterLabel" class="footer-tsa hidden">TSA Verified • DigiCert RFC 3161 • Cautio Verification Certificate</div>
  </div>

  <script>
(function () {
  const appCard = document.getElementById('appCard');
  const dropZone = document.getElementById('dropZone');
  const dropZoneText = document.getElementById('dropZoneText');
  const loadedFileName = document.getElementById('loadedFileName');
  const loadedFileCode = document.getElementById('loadedFileCode');
  const resultsCard = document.getElementById('resultsCard');
  const preview = document.getElementById('preview');
  const statusText = document.getElementById('statusText');
  const statusPill = document.getElementById('statusPill');
  const expectedRootCode = document.getElementById('expectedRootCode');
  const computedRootCode = document.getElementById('computedRootCode');
  const merkleViz = document.getElementById('merkleViz');
  const downloadReport = document.getElementById('downloadReport');
  const resetBtn = document.getElementById('resetBtn');
  const largeFileWarning = document.getElementById('largeFileWarning');
  const previewTruncatedBanner = document.getElementById('previewTruncatedBanner');
  const errorBanner = document.getElementById('errorBanner');
  const errorMsg = document.getElementById('errorMsg');
  const algorithmLabel = document.getElementById('algorithmLabel');
  const compareSection = document.getElementById('compareSection');
  const expectedHashBlock = document.getElementById('expectedHashBlock');
  const computedHashBlock = document.getElementById('computedHashBlock');
  const conclusionText = document.getElementById('conclusionText');
  const verificationDateVal = document.getElementById('verificationDateVal');
  const tsaFooterLabel = document.getElementById('tsaFooterLabel');

  const PREVIEW_MAX_CHARS = 1000;
  const LARGE_FILE_BYTES = 1024 * 1024;
  const LARGE_PREVIEW_BYTES = 10 * 1024 * 1024;
  const ERR_ROOT_MISMATCH = 'INVALID – Calculated root does not match provided root (possible tampering or corruption).';
  const ERR_MISSING_FIELDS = 'Invalid proof: Missing required fields (file_content, root, proof, or hash_algorithm).';
  const ERR_PARSE = 'Invalid file format – not valid JSON.';
  const ERR_READ = 'Invalid file format – could not read file.';
  const ERR_MALFORMED_PROOF = 'Invalid proof data: Malformed hash or sibling format. Merkle path rejected.';

  let state = { proof: null, valid: false, leafHash: null, root: null, computedRoot: null, steps: [], fileName: '', error: null, largeFile: false, parsedSuccessfully: false, hashAlgorithm: 'Keccak-256' };

  function normalizeHex(h) {
    if (!h) return '';
    return String(h).replace(/^0x/, '').trim().toLowerCase();
  }
  function truncateMiddle(h, head, tail) {
    head = head || 10; tail = tail || 10;
    const s = normalizeHex(h);
    if (!s) return '—';
    if (s.length <= head + tail + 3) return s;
    return s.slice(0, head) + '…' + s.slice(-tail);
  }
  function escapeHtml(str) {
    if (!str) return '';
    const div = document.createElement('div');
    div.textContent = str;
    return div.innerHTML;
  }
  function setCode(el, hex, opts) {
    opts = opts || {};
    const s = normalizeHex(hex);
    const display = s ? truncateMiddle(s, 8, 6) : (opts.missingText || '—');
    if (s) {
      el.innerHTML = '<span class="hash" title="' + escapeHtml(s) + '">' + escapeHtml(display) + '</span>';
    } else {
      el.textContent = display;
      el.removeAttribute('title');
    }
    el.classList.toggle('mismatch', !!opts.mismatch);
  }
  function renderDiff(expectedHex, computedHex) {
    const a = normalizeHex(expectedHex);
    const b = normalizeHex(computedHex);
    const len = Math.max(a.length, b.length);
    let outA = '', outB = '';
    for (let i = 0; i < len; i++) {
      const ca = a[i] || ' ';
      const cb = b[i] || ' ';
      const bad = ca !== cb;
      const span = bad ? 'diff-mismatch' : 'diff';
      outA += '<span class="' + span + '">' + escapeHtml(ca) + '</span>';
      outB += '<span class="' + span + '">' + escapeHtml(cb) + '</span>';
    }
    return { outA: outA, outB: outB };
  }
  function setStatus(mode, message) {
    statusText.textContent = message || '';
    statusPill.className = 'pill';
    appCard.classList.toggle('state-invalid', mode === 'invalid');
    if (mode === 'valid') { statusPill.textContent = 'AUTHENTIC'; statusPill.classList.add('verified'); tsaFooterLabel.classList.remove('hidden'); }
    else if (mode === 'invalid') { statusPill.textContent = 'TAMPERING DETECTED'; statusPill.classList.add('tamper'); tsaFooterLabel.classList.add('hidden'); }
    else { statusPill.textContent = 'VERIFYING'; tsaFooterLabel.classList.add('hidden'); }
  }
  function setErrorBanner(msg) {
    if (msg) { errorMsg.textContent = String(msg); errorBanner.classList.add('show'); }
    else { errorMsg.textContent = ''; errorBanner.classList.remove('show'); }
  }
  function formatVerificationDate(proof) {
    var iso = (proof && (proof.timestamp || proof.tsa_timestamp)) || null;
    if (iso) {
      var d = new Date(iso);
      if (!isNaN(d.getTime())) {
        var y = d.getUTCFullYear();
        var m = String(d.getUTCMonth() + 1).padStart(2, '0');
        var day = String(d.getUTCDate()).padStart(2, '0');
        var h = String(d.getUTCHours()).padStart(2, '0');
        var min = String(d.getUTCMinutes()).padStart(2, '0');
        var s = String(d.getUTCSeconds()).padStart(2, '0');
        return y + '-' + m + '-' + day + ' ' + h + ':' + min + ':' + s + ' UTC';
      }
    }
    return new Date().toUTCString();
  }
  function setVerificationDate(proof) {
    verificationDateVal.textContent = proof ? formatVerificationDate(proof) : new Date().toUTCString();
  }
  function updateCompare(expectedHex, computedHex, isMismatch) {
    if (!expectedHex || !computedHex || !isMismatch) {
      compareSection.classList.remove('show');
      expectedHashBlock.innerHTML = '';
      computedHashBlock.innerHTML = '';
      conclusionText.textContent = '';
      return;
    }
    const d = renderDiff(expectedHex, computedHex);
    expectedHashBlock.innerHTML = d.outA;
    computedHashBlock.innerHTML = d.outB;
    compareSection.classList.add('show');
    conclusionText.innerHTML = '<strong>Conclusion:</strong> File content altered since timestamp. Document is not authentic.';
  }

  function keccak256(bytesOrHex) {
    const hex = typeof bytesOrHex === 'string'
      ? (bytesOrHex.startsWith('0x') ? bytesOrHex : '0x' + bytesOrHex)
      : '0x' + Array.from(bytesOrHex).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
    return ethers.keccak256(hex);
  }
  function verifyMerkleProof(leafHashHex, proof, rootHex) {
    var current = leafHashHex.startsWith('0x') ? leafHashHex : '0x' + leafHashHex;
    var root = rootHex.startsWith('0x') ? rootHex : '0x' + rootHex;
    var steps = [{ label: 'Leaf', hash: current, valid: true }];
    for (var i = 0; i < proof.length; i++) {
      var sibling = proof[i].data.startsWith('0x') ? proof[i].data : '0x' + proof[i].data;
      var left = proof[i].position === 'left' ? sibling : current;
      var right = proof[i].position === 'right' ? sibling : current;
      var combined = (left.startsWith('0x') ? left.slice(2) : left) + (right.startsWith('0x') ? right.slice(2) : right);
      current = ethers.keccak256('0x' + combined);
      steps.push({ label: 'Sibling ' + (i + 1), hash: sibling, valid: true });
    }
    steps.push({ label: 'Root', hash: current, valid: current.toLowerCase() === root.toLowerCase() });
    return { valid: steps[steps.length - 1].valid, steps: steps, computedRoot: current };
  }
  function renderPreview(contentBase64) {
    previewTruncatedBanner.classList.remove('show');
    if (!contentBase64) { preview.textContent = '(no content)'; return; }
    try {
      var decodedLen = Math.floor((contentBase64.length * 3) / 4);
      if (decodedLen > LARGE_PREVIEW_BYTES) { preview.textContent = 'Large file — no preview generated.'; return; }
      var binary = atob(contentBase64);
      var bytes = new Uint8Array(binary.length);
      for (var i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
      var blob = new Blob([bytes]);
      var first = bytes[0], second = bytes[1];
      if (first === 0xFF && second === 0xD8) {
        var url = URL.createObjectURL(blob);
        var img = document.createElement('img');
        img.src = url;
        preview.innerHTML = '';
        preview.appendChild(img);
        return;
      }
      if (first === 0x89 && second === 0x50) {
        url = URL.createObjectURL(blob);
        img = document.createElement('img');
        img.src = url;
        preview.innerHTML = '';
        preview.appendChild(img);
        return;
      }
      var text = new TextDecoder('utf-8', { fatal: false }).decode(bytes);
      var truncated = text.length > PREVIEW_MAX_CHARS;
      preview.textContent = truncated ? text.slice(0, PREVIEW_MAX_CHARS) + '\n... [Full content available in original bundle]' : text;
      if (truncated) previewTruncatedBanner.classList.add('show');
    } catch (e) { preview.textContent = '(binary or invalid base64)'; }
  }
  function renderMerklePath(valid, steps, proof) {
    merkleViz.innerHTML = '';
    merkleViz.classList.toggle('invalid', !valid);
    merkleViz.classList.toggle('valid', valid);
    if (!steps || steps.length === 0) {
      var row = document.createElement('div');
      row.className = 'merkle-row';
      row.innerHTML = '<span class="merkle-connector">No path data</span>';
      merkleViz.appendChild(row);
      return;
    }
    var leafStep = steps[0], rootStep = steps[steps.length - 1];
    var row1 = document.createElement('div');
    row1.className = 'merkle-row';
    var leafNode = document.createElement('div');
    leafNode.className = 'merkle-node leaf ' + (valid ? 'valid' : 'invalid');
    leafNode.title = leafStep.hash;
    leafNode.textContent = leafStep.hash.slice(0, 10) + '…' + leafStep.hash.slice(-6);
    row1.appendChild(leafNode);
    merkleViz.appendChild(row1);
    if (proof && proof.length > 0) {
      var row2 = document.createElement('div');
      row2.className = 'merkle-row';
      row2.innerHTML = '<span class="merkle-connector">↑ siblings</span>';
      merkleViz.appendChild(row2);
      var row3 = document.createElement('div');
      row3.className = 'merkle-row';
      proof.forEach(function(p, idx) {
        var n = document.createElement('div');
        n.className = 'merkle-node ' + (valid ? 'valid' : 'invalid');
        var h = p.data.startsWith('0x') ? p.data : '0x' + p.data;
        n.title = h;
        n.textContent = h.slice(0, 10) + '…' + h.slice(-6);
        row3.appendChild(n);
      });
      merkleViz.appendChild(row3);
      var row4 = document.createElement('div');
      row4.className = 'merkle-row';
      row4.innerHTML = '<span class="merkle-connector">↑ root</span>';
      merkleViz.appendChild(row4);
    }
    var rowRoot = document.createElement('div');
    rowRoot.className = 'merkle-row';
    var rootNode = document.createElement('div');
    rootNode.className = 'merkle-node root ' + (valid ? 'valid' : 'invalid');
    rootNode.title = rootStep.hash;
    rootNode.textContent = rootStep.hash.slice(0, 10) + '…' + rootStep.hash.slice(-6);
    rowRoot.appendChild(rootNode);
    merkleViz.appendChild(rowRoot);
  }

  function processFile(file) {
    state = { proof: null, valid: false, leafHash: null, root: null, computedRoot: null, steps: [], fileName: file.name, error: null, largeFile: file.size > LARGE_FILE_BYTES, parsedSuccessfully: false, hashAlgorithm: 'Keccak-256' };
    dropZoneText.textContent = 'Drop proof.json here or click to browse';
    loadedFileCode.textContent = file.name;
    loadedFileName.classList.remove('hidden');
    largeFileWarning.classList.toggle('show', state.largeFile);
    previewTruncatedBanner.classList.remove('show');
    resultsCard.classList.add('show');
    setStatus('verifying', 'Running local verification…');
    setErrorBanner(null);
    setCode(expectedRootCode, null);
    setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
    setVerificationDate(null);
    updateCompare(null, null, false);
    merkleViz.innerHTML = '';
    merkleViz.classList.remove('invalid', 'valid');
    preview.textContent = '';

    var fr = new FileReader();
    fr.onload = function() {
      try {
        var json = JSON.parse(fr.result);
        var fileContentB64 = json.file_content;
        var proof = json.proof;
        var root = json.root;
        var hashAlg = json.hash_algorithm;
        var algo = (hashAlg && String(hashAlg).toLowerCase() === 'sha256') ? 'SHA-256' : 'Keccak-256';
        state.hashAlgorithm = algo;
        algorithmLabel.textContent = algo;
        setVerificationDate(json);

        if (!proof || !Array.isArray(proof) || !root) {
          state.error = ERR_MISSING_FIELDS;
          state.valid = false;
          state.parsedSuccessfully = true;
          state.root = (root != null && root !== '') ? ('0x' + String(root).replace(/^0x/, '')) : null;
          setStatus('invalid', 'Proof rejected');
          setErrorBanner(state.error);
          setCode(expectedRootCode, state.root);
          setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
          renderPreview(null);
          merkleViz.classList.add('invalid');
          merkleViz.classList.remove('valid');
          renderMerklePath(false, [], null);
          downloadReport.disabled = false;
          return;
        }

        var rawBytes = fileContentB64 ? Uint8Array.from(atob(fileContentB64), function(c) { return c.charCodeAt(0); }) : new Uint8Array(0);
        var leafHash = null;
        try { leafHash = rawBytes.length > 0 ? keccak256(rawBytes) : null; } catch (cryptoErr) {
          console.error('Cautio verifier (keccak256):', cryptoErr);
          state.error = ERR_MALFORMED_PROOF;
          state.valid = false;
          state.parsedSuccessfully = true;
          state.root = (root != null && root !== '') ? ('0x' + String(root).replace(/^0x/, '')) : null;
          setStatus('invalid', 'Proof rejected');
          setErrorBanner(state.error);
          setCode(expectedRootCode, state.root);
          setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
          renderPreview(fileContentB64);
          merkleViz.classList.add('invalid');
          merkleViz.classList.remove('valid');
          renderMerklePath(false, [], proof);
          downloadReport.disabled = false;
          return;
        }
        if (!leafHash && proof.length > 0) {
          state = { proof: json, valid: false, error: ERR_MISSING_FIELDS, root: root.startsWith('0x') ? root : '0x' + root, computedRoot: null, steps: [], fileName: file.name, largeFile: state.largeFile, parsedSuccessfully: true, hashAlgorithm: state.hashAlgorithm };
          setStatus('invalid', 'Proof rejected');
          setErrorBanner(state.error);
          setCode(expectedRootCode, state.root);
          setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
          renderPreview(fileContentB64);
          merkleViz.classList.add('invalid');
          merkleViz.classList.remove('valid');
          renderMerklePath(false, [], proof);
          downloadReport.disabled = false;
          return;
        }
        var rootHex = root.startsWith('0x') ? root : '0x' + root;
        var result;
        try { result = verifyMerkleProof(leafHash, proof, rootHex); } catch (verifyErr) {
          console.error('Cautio verifier (verifyMerkleProof):', verifyErr);
          state = { proof: json, valid: false, error: ERR_MALFORMED_PROOF, root: rootHex, computedRoot: null, steps: [], fileName: file.name, largeFile: state.largeFile, parsedSuccessfully: true, hashAlgorithm: state.hashAlgorithm };
          setStatus('invalid', 'Proof rejected');
          setErrorBanner(state.error);
          setCode(expectedRootCode, state.root);
          setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
          renderPreview(fileContentB64);
          merkleViz.classList.add('invalid');
          merkleViz.classList.remove('valid');
          renderMerklePath(false, [], proof);
          downloadReport.disabled = false;
          return;
        }
        var valid = result.valid;
        state = { proof: json, valid: valid, leafHash: leafHash, root: rootHex, computedRoot: result.computedRoot, steps: result.steps, fileName: file.name, error: valid ? null : ERR_ROOT_MISMATCH, largeFile: state.largeFile, parsedSuccessfully: true, hashAlgorithm: state.hashAlgorithm };
        if (valid) { setStatus('valid', 'Integrity Confirmed'); setErrorBanner(null); }
        else { setStatus('invalid', 'Root mismatch'); setErrorBanner(state.error); }
        setCode(expectedRootCode, state.root);
        setCode(computedRootCode, state.computedRoot, { mismatch: !valid });
        var expHex = normalizeHex(state.root);
        var compHex = normalizeHex(state.computedRoot);
        updateCompare(state.root, state.computedRoot, !valid && expHex && compHex && expHex !== compHex);
        renderPreview(fileContentB64);
        merkleViz.classList.toggle('valid', valid);
        merkleViz.classList.toggle('invalid', !valid);
        renderMerklePath(valid, result.steps, proof);
        downloadReport.disabled = false;
      } catch (e) {
        state = { proof: null, valid: false, leafHash: null, root: null, computedRoot: null, steps: [], fileName: file.name, error: ERR_PARSE, largeFile: state.largeFile, parsedSuccessfully: false, hashAlgorithm: 'Keccak-256' };
        setStatus('invalid', 'Invalid file');
        setErrorBanner(state.error);
        setVerificationDate(null);
        setCode(expectedRootCode, null);
        setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
        renderPreview(null);
        merkleViz.innerHTML = '';
        merkleViz.classList.add('invalid');
        updateCompare(null, null, false);
        downloadReport.disabled = false;
      }
    };
    fr.onerror = function() {
      state = { proof: null, valid: false, leafHash: null, root: null, computedRoot: null, steps: [], fileName: file.name, error: ERR_READ, largeFile: state.largeFile, parsedSuccessfully: false, hashAlgorithm: 'Keccak-256' };
      setStatus('invalid', 'Invalid file');
      setErrorBanner(state.error);
      setVerificationDate(null);
      setCode(expectedRootCode, null);
      setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
      renderPreview(null);
      merkleViz.innerHTML = '';
      merkleViz.classList.add('invalid');
      updateCompare(null, null, false);
      downloadReport.disabled = false;
    };
    fr.readAsText(file);
  }

  var input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json,application/json';
  input.className = 'hidden';
  input.addEventListener('change', function() { var f = input.files && input.files[0]; if (f) processFile(f); });
  document.body.appendChild(input);
  dropZone.addEventListener('click', function() { input.click(); });
  dropZone.addEventListener('keydown', function(e) { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); input.click(); } });
  dropZone.addEventListener('dragenter', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragover', function(e) { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', function(e) { e.preventDefault(); dropZone.classList.remove('dragover'); });
  dropZone.addEventListener('drop', function(e) {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    var f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
    if (f) processFile(f);
  });

  resetBtn.addEventListener('click', function() {
    resultsCard.classList.add('fade-out');
    setTimeout(function() {
      state = { proof: null, valid: false, leafHash: null, root: null, computedRoot: null, steps: [], fileName: '', error: null, largeFile: false, parsedSuccessfully: false, hashAlgorithm: 'Keccak-256' };
      appCard.classList.remove('state-invalid');
      dropZoneText.textContent = 'Drop proof.json here or click to browse';
      loadedFileCode.textContent = '';
      loadedFileName.classList.add('hidden');
      setErrorBanner(null);
      setCode(expectedRootCode, null);
      setCode(computedRootCode, null, { missingText: '— (failed to compute)' });
      updateCompare(null, null, false);
      largeFileWarning.classList.remove('show');
      previewTruncatedBanner.classList.remove('show');
      preview.textContent = '';
      merkleViz.innerHTML = '';
      merkleViz.classList.remove('invalid', 'valid');
      resultsCard.classList.remove('show', 'fade-out');
      tsaFooterLabel.classList.add('hidden');
      verificationDateVal.textContent = '—';
      input.value = '';
    }, 300);
  });

  downloadReport.addEventListener('click', function() {
    try {
      var JsPDF = (window.jspdf && window.jspdf.jsPDF) || window.jsPDF;
      if (!JsPDF) { alert('jsPDF not loaded.'); return; }
      var doc = new JsPDF();
      var w = doc.internal.pageSize.getWidth();
      var ts = new Date().toISOString();
      var isValid = state.valid === true;
      doc.setFillColor(22, 27, 34);
      doc.rect(0, 0, w, doc.internal.pageSize.getHeight(), 'F');
      doc.setFont('courier', 'bold');
      doc.setFontSize(22);
      if (isValid) { doc.setTextColor(0, 255, 157); doc.text('TSA Verified • DigiCert RFC 3161 • Cautio Verification Certificate', w / 2, 24, { align: 'center' }); }
      else { doc.setTextColor(255, 77, 79); doc.text('Cautio FAILURE REPORT', 20, 24); }
      doc.setFont('courier', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(230, 237, 243);
      var y = 34;
      doc.text('Generated: ' + ts, 20, y); y += 8;
      doc.text('Verified Proof File: ' + (state.fileName || 'proof.json'), 20, y); y += 8;
      doc.text('Hash Algorithm: ' + (state.hashAlgorithm || 'Keccak-256'), 20, y); y += 8;
      y += 6;
      doc.setFontSize(24);
      doc.setFont('courier', 'bold');
      if (isValid) { doc.setTextColor(0, 255, 157); doc.text('Status: AUTHENTIC', w / 2, y + 6, { align: 'center' }); }
      else { doc.setTextColor(255, 77, 79); doc.text('Status: INVALID', w / 2, y + 6, { align: 'center' }); }
      doc.setFont('courier', 'normal');
      y += 18;
      doc.setFontSize(10);
      doc.setTextColor(230, 237, 243);
      var providedRoot = (state.root || (state.proof && state.proof.root) || '').replace(/^0x/, '') || '—';
      doc.text('Provided Root Hash: ' + providedRoot, 20, y); y += 6;
      var computedRootText = state.computedRoot ? (state.computedRoot + '').replace(/^0x/, '') : '— (failed to compute)';
      doc.text('Computed Root Hash: ' + computedRootText, 20, y); y += 8;
      if (state.error) {
        doc.setFontSize(9);
        doc.setTextColor(255, 150, 150);
        var lines = doc.splitTextToSize('Error/Message: ' + String(state.error), w - 40);
        doc.text(lines, 20, y);
        y += lines.length * 5 + 6;
        doc.setTextColor(230, 237, 243);
        doc.setFontSize(10);
      }
      y = doc.internal.pageSize.getHeight() - 18;
      doc.setFontSize(8);
      doc.setTextColor(139, 148, 158);
      doc.text('Verified offline — no data transmitted. Integrity since notarization only.', w / 2, y, { align: 'center' });
      doc.save(isValid ? 'cautio-verification-certificate.pdf' : 'cautio-failure-report.pdf');
    } catch (err) {
      alert('Failed to generate PDF: ' + (err && (err.message || err.toString()) || 'Unknown error'));
    }
  });
})();
  </script>
</body>
</html>
